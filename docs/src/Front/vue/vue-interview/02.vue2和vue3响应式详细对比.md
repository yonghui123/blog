## vue2 中响应式详解

### vue2 初始化方法

在`src/core/instance/index.js`中找到 vue 构造函数：

```js
function Vue(options) {
  this._init(options);
}
```

`_init`函数的实现：

```js
//初始化顺序：生命周期->事件监听->渲染->beforeCreate->注入->state初始化->provide->created
vm._self = vm;
initLifecycle(vm);
initEvents(vm);
initRender(vm);
callHook(vm, "beforeCreate");
initInjections(vm); // resolve injections before data/props
initState(vm); // 初始化 props/data/watch/methods, 此处会是研究数据响应化的重点
initProvide(vm); // resolve provide after data/props
callHook(vm, "created");

//如果存在el元素，则会自动执行$mount，这也是必须要理解的
//也就是说，在写法上如果有el元素，可以省略$mount
if (vm.$options.el) {
  vm.$mount(vm.$options.el);
}
```

真正了解数据响应式的重点在`initState`函数中。

在`mountComponent`函数中，实现了组件挂载的细节：

```js
//这才是真正的mount函数
export function mountComponent (
  vm: Component,
  el: ?Element,
  hydrating?: boolean
): Component {
  ...
  callHook(vm, 'beforeMount')
  //核心代码逻辑
  let updateComponent
  /* istanbul ignore if */
  if (process.env.NODE_ENV !== 'production' && config.performance && mark) {
    ...
  } else {
    updateComponent = () => {
      //更新Component，主要做了两个事情：render(生成vdom)、update(转换vdom为dom)
      vm._update(vm._render(), hydrating)
    }
  }

  // 在此处定义Watcher(一个Vue实例对应的是一个Watcher)，并且与updateComponent关联起来
  new Watcher(vm, updateComponent, noop, {
    before () {
      if (vm._isMounted && !vm._isDestroyed) {
        callHook(vm, 'beforeUpdate')
      }
    }
  }, true /* isRenderWatcher */)
  hydrating = false

  if (vm.$vnode == null) {
    vm._isMounted = true
    callHook(vm, 'mounted')
  }
  return vm
}
```
可以看到组件挂载的时候，就会创建一个Watcher，并且将updateComponent与Watcher关联起来。  
组件和Watcher是一一对应的关系。  

### vue2 数据响应式实现

vue2的响应式实现依赖三个成员： `Observer`、 `Dep`、 `Watcher`

三者的关系流程：
1. Observer 负责拦截数据，拦截到数据之后拦截Dep  
2. Dep是调度中心，负责收集依赖和通知更新  
3. Watcher负责订阅Dep和执行渲染

其中`Watcher`在挂载组件的时候实例化，`Watcher`和组件是一一对应的。  

后续介绍`Dep`和`Observer`

看了挂载事件之后回到初始化函数的initState函数中，从函数名可以得知是对组件数据的初始化。  
该函数在`src/core/instance/init.js`中。  
```ts
function initState(vm: Component) {
  vm._watchers = [];
  const opts = vm.$options;
  if (opts.props) { initProps(vm, opts.props); }
  if (opts.methods) { initMethods(vm, opts.methods); }
  if (opts.data) {
    initData(vm);
  } else {
    observe(vm._data = {}, true /* asRootData */);
  }
  if (opts.computed) { initComputed(vm, opts.computed); }
  if (opts.watch && opts.watch !== nativeWatch) {
    initWatch(vm, opts.watch);
  }
}
```
响应式数据只关心`vm._data`的部分，可以看到`vm._data`是作为`observe`函数的参数，所以实际创建响应式还需要查看`observe`函数。  

在`src/core/observer/index.js`中查看`observe`函数。  
```ts
function observe(value: any, asRootData: boolean): Observer | void {
  if (!isObject(value) || value instanceof VNode) {
    return;
  }
  let ob: Observer | void;
  
  ob = new Observer(value);

  return ob;
}
```


